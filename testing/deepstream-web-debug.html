<!DOCTYPE html>
<html>

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/deepstream.io-client-js/2.2.1/deepstream.js"></script>
</head>

<body>
    <input type="text" id="text" />
    <input type="button" value="Send" onclick="send()" />
    <script type="text/javascript">
        var debug = true;
        var deepstreamURL = "ws://localhost:6020/deepstream";
        var user = "gej7bWdWsgVMOz5ns3iwMKjHbs0jKnBx";
        var fakeUser = "gej7bWdWsgVMOz5ns2iwMKjHbs0jKnBx";
        var secret = "G3LmAVUAbiXczMTvfWXFq1KxaSpqLKGt2kOJuwgC630ntJpgluedhBos5wFUyxBu8zFXGOVV3GXwW646SNIlOpUHxa9yTC6fJDcXxTjqsGN7kCH9HG6p5juuJjsOaDzG";
        var role = "participant";
        var interventionPattern = "Deepstream Demo.*";
        var interventionPassword = "1234secret";
        var timestamp = 0;

        var restURL = "http://localhost:8080/MC/api/v02/";
        var restUser = "ds:" + user;
        var restToken = null;

        var client;

        var log = function(message) {
            if (debug)
                console.log(message);
        };

        var init = function() {
            log("Connecting...");
            client = deepstream(deepstreamURL).login({
                    "user": user,
                    "secret": secret,
                    "role": role,
                    "intervention-password": interventionPassword
                },
                function(success, result) {
                    if (success) {
                        log("Connected.");

                        log("Getting old messages...");
                        client.rpc.make("message-diff", {
                            "user": user,
                            "timestamp": timestamp
                        }, function(err, result) {
                            if (result != null) {
                                log("Update result:");
                                timestamp = result["latest-timestamp"];
                                log("Latest timestamp: " + timestamp);

                                log("Older messsages:");
                                log(result["list"]);
                                for (var i in result["list"]) {
                                    log(result["list"][i]);
                                }
                            } else {
                                log("Error when retrieving old messages!");
                            }
                        });

                        log("Getting REST token...");
                        client.rpc.make("rest-token", {
                            "user": user
                        }, function(err, result) {
                            if (result != null) {
                                log("REST token result:");
                                log(result);
                                restToken = result;

                                // REST example
                                restCall("variable/read/test");
                            } else {
                                log("Error when retrieving REST token!");
                            }
                        });

                        /*
                        var record = client.record.getRecord("messages/" + user);
                        record.whenReady(record => {
                            log("Listening for changes of user " + user + "...");
                            client.event.subscribe("message-update/" + user, function(
                                message) {
                                log("Message " + message.id + ":");
                                log(message);
                            });
                        });
                        */

                        client.event.subscribe("message-update/" + user, function(message) {
                            log("Message " + message.id + ":");
                            log(message);
                        });
                    } else {
                        log("Could not connect.")
                    }
                });
        };

        var send = function() {
            var message = document.getElementById("text").value;
            var timestamp = (new Date()).getTime();
            log("Sending message \"" + message + "\" with timestamp " +
                timestamp + "...");

            client.rpc.make("user-message", {
                "user": user,
                "message": message,
                "timestamp": timestamp
            }, function(err, result) {
                log("Sending result:");
                log(result);
            });

            document.getElementById("text").value = "";
        };

        var restCall = function(command, postData = null) {
            log(restURL + command);
            $.ajax({
                type: postData == null ? "GET" : "POST",
                data: postData,
                dataType: "json",
                contentType: postData == null ? "application/json; charset=UTF-8" : "text/plain; charset=UTF-8",
                beforeSend: function(request) {
                    request.setRequestHeader("user", restUser);
                    request.setRequestHeader("token", restToken);
                },
                url: restURL + command,
                success: function(data) {
                    log("SUCCESS: " + command);
                    log("Returned: " + JSON.stringify(data, null, 2));
                },
                error: function(xhr, exception) {
                    log(xhr.statusCode());
                    log("ERROR: " + command);
                }
            });
        };

        $(document).ready(function() {
            init();
        });

    </script>
</body>

</html>
