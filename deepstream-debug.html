<!DOCTYPE html>
<html>
<head>
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/deepstream.io-client-js/2.2.1/deepstream.js"></script>
</head>
<body>
	<input type="text" id="text" />
	<input type="button" value="Send" onclick="send()" />
	<script type="text/javascript">
		var debug = true;
		var participant = "123456789";
		var timestamp = 1502291961398;

		var client;

		var log = function(message) {
			if (debug)
				console.log(message);
		}

		var init = function() {
			log("Connecting...");
			client = deepstream("wss://deepstream.pathmate.online:8443").login(
					{
						"username" : "development",
						"password" : "pm2017-public"
					});
			log("Connected.");

			
			log("Getting old messages...");
						client.rpc.make("message-diff", {
				"participant" : participant,
				"timestamp" : timestamp
			}, function(err, result) {
				log("Update result:");
				timestamp = result.latest-timestamp;
				
				log("Older messsages:");
				log(result.list);
			});
			
			var record = client.record.getRecord("messages/" + participant);

			record.whenReady(record => {
					log("Listening for changes of participant " + participant + "...");
					client.event.subscribe("message-update/" + participant, function(
							messageId) {
							log("Message " + messageId + ":");
							log(record.get("list/" + messageId));
					});
				});
		};
		
		
		var send = function() {
			var message = document.getElementById("text").value;
			var timestamp = (new Date()).getTime();
			log("Sending message \"" + message + "\" with timestamp "
					+ timestamp + "...");

			client.rpc.make("message-inbox", {
				"participant" : participant,
				"message" : message,
				"timestamp" : timestamp
			}, function(err, result) {
				log("Sending result:");
				log(result);
			});

			document.getElementById("text").value = "";
		};

		init();
	</script>
</body>
</html>