<!DOCTYPE html>
<html>
<head>
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/deepstream.io-client-js/2.2.1/deepstream.js"></script>
</head>
<body>
	<input type="text" id="text" />
	<input type="button" value="Send" onclick="send()" />
	<script type="text/javascript">
		var debug = true;
		var participant = "12345678";
		var last = -1;

		var client;

		var log = function(message) {
			if (debug)
				console.log(message);
		}

		var init = function() {
			log("Connecting...");
			client = deepstream("wss://deepstream.pathmate.online:8443").login(
					{
						"username" : "development",
						"password" : "pm2017-public"
					});
			log("Connected.");

			var record = client.record.getRecord("messages/" + participant);

			log("Getting old messages...");
			record.whenReady(record => {
				  var newestId = record.get("newest");
				  
				  for (var i = last + 1; i <= newestId; i++) {
						log("Message " + i + ":");
						log(record.get("list/" + i));
					}
					last = newestId * 1;
					
					log("Listening for changes of participant " + participant + "...");
					client.event.subscribe("message-update/" + participant, function(
							newestId) {
						
						if ( newestId <= last) {
							log("Updated Message " + newestId + ":");
							log(record.get("list/" + newestId));
						} else {
						for (var i = last + 1; i <= newestId; i++) {
							log("New Message " + i + ":");
							log(record.get("list/" + i));
						}
						last = newestId * 1;
						}
					});
				});
		};

		var send = function() {
			var message = document.getElementById("text").value;
			var timestamp = (new Date()).getTime();
			log("Sending message \"" + message + "\" with timestamp "
					+ timestamp + "...");

			client.rpc.make("inbox", {
				"participant" : participant,
				"message" : message,
				"timestamp" : timestamp
			}, function(err, result) {
				log("Sending result:");
				log(result);
			});

			document.getElementById("text").value = "";
		}

		init();
	</script>
</body>
</html>