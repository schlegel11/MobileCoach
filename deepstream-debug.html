<!DOCTYPE html>
<html>
<head>
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/deepstream.io-client-js/2.2.1/deepstream.js"></script>
</head>
<body>
	<input type="text" id="text" />
	<input type="button" value="Send" onclick="send()" />
	<script type="text/javascript">
		var debug = true;
		var user = "123456789";
		var role = "user";
		var timestamp = 0;

		var client;

		var log = function(message) {
			if (debug)
				console.log(message);
		};

		var init = function() {
			log("Connecting...");
			client = deepstream("ws://localhost:6020/deepstream").login(
					{
						"user" : user,
						"role" : role,
						"secret" : "def"
					});
			log("Connected.");

			
			log("Getting old messages...");
						client.rpc.make("message-diff", {
				"user" : user,
				"timestamp" : timestamp
			}, function(err, result) {
				if (result != null) {
					log("Update result:");
					timestamp = result["latest-timestamp"];
					log("Latest timestamp: " + timestamp);
					
					log("Older messsages:");
					log(result["list"]);
					for (var i in result["list"]) {
						log(result["list"][i]);
					}
				} else {
					log("Error when retrieving old messages!");
				}
			});
			
			var record = client.record.getRecord("messages/" + user);

			record.whenReady(record => {
					log("Listening for changes of user " + user + "...");
					client.event.subscribe("message-update/" + user, function(
							messageId) {
							log("Message " + messageId + ":");
							log(record.get("list/" + messageId));
					});
				});
		};
		
		
		var send = function() {
			var message = document.getElementById("text").value;
			var timestamp = (new Date()).getTime();
			log("Sending message \"" + message + "\" with timestamp "
					+ timestamp + "...");

			client.rpc.make("message-inbox", {
				"user" : user,
				"message" : message,
				"timestamp" : timestamp
			}, function(err, result) {
				log("Sending result:");
				log(result);
			});

			document.getElementById("text").value = "";
		};

		init();
	</script>
</body>
</html>